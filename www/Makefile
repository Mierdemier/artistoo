.SECONDARY:
.DELETE_ON_ERROR:


all : web-all


restart :
	touch $@

# Step 1 : Build main site with mustache

../mustache-web/public/layout.html : always
	@echo "		Building mustache website" && cd ../mustache-web && $(MAKE) -B

progress :
	@mkdir -p $@

progress/step1 : ../mustache-web/public/layout.html | progress
	@touch $@

# Step 2 : Port mustache-generated layout to mytemplate
../esdoc-template-artistoo/layout.html : ../mustache-web/public/layout.html progress/step1
	@echo "		Updating esdoc template with layout.html from mustache" && cp $< $@

progress/step2 : ../esdoc-template-artistoo/layout.html | progress
	@touch $@

# Step 3 : Auto-build documentation with esdoc; this contains:
#	- "Documentation"
#	- "Source"
#	- "Tests"
#	- link to github
#	- search index of all the auto-generated pages.
progress/step3 : progress/step2 
		@echo "		Updating esdoc docs" && cd .. && $(MAKE) docs/index.html && cd www && touch $@
	

# Step 4: copy all esdoc stuff into this folder:
progress/step4 : progress/step3
	@echo "		Copying esdoc docs" && cp -r ../docs/* . && touch $@
	

# Step 5: add mustache-generated stuff (which includes an index.html to overwrite
# the one generated by esdoc, so this step should come after copying the esdoc stuff.)
progress/step5 : progress/step2 progress/step4
	@echo "		Adding mustache pages" && cp -r ../mustache-web/public/* . && touch $@
	

# Step 6: add extra files such as examples and manual assets
converter :	../mustache-web/sources/converter progress/step3
	@echo "		Adding converter pages" && cp -r $< .
	
examples :
	@mkdir -p $@

example-files : ../examples/html progress/step3 | examples
	@echo "		Adding example html files" && cp $</* examples/ && \
	cp ../examples/3D/cpm3d.html examples/ && \
	cp ../examples/3D/Canvas3D.js examples/ && \
	cp ../examples/3D/OrbitControls.js examples/

manual/asset : ../mustache-web/sources/manual/asset progress/step3 converter
	@echo "		Adding manual asset files" &&  cp -r $< $@

progress/step6 : converter example-files manual/asset
	@touch $@


web-all : progress/step5 progress/step6
	@echo "Done!" && touch restart && rm -rf progress
